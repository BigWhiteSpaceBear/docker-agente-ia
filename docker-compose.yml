include:
  - ./docker-compose-base.yml

# =============================================================================
# SISTEMA HÍBRIDO DE AGENTES DE IA - ANÁLISE DE RISCO FINANCEIRO
# Este arquivo estende o docker-compose-base.yml do RAGFlow
# AJUSTADO PARA CRIAR TABELAS CORRETAMENTE
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # RAGFLOW CPU - Configuração original do RAGFlow (para quem não tem GPU)
  # ---------------------------------------------------------------------------
  ragflow-cpu:
    depends_on:
      mysql:
        condition: service_healthy
    profiles:
      - cpu
    image: ${RAGFLOW_IMAGE}
    command:
      - --enable-adminserver
    ports:
      - ${SVR_WEB_HTTP_PORT}:80
      - ${SVR_WEB_HTTPS_PORT}:443
      - ${SVR_HTTP_PORT}:9380
      - ${ADMIN_SVR_HTTP_PORT}:9381
      - ${SVR_MCP_PORT}:9382
    volumes:
      - ./ragflow-logs:/ragflow/logs
      - ./nginx/ragflow.conf:/etc/nginx/conf.d/ragflow.conf
      - ./nginx/proxy.conf:/etc/nginx/proxy.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./service_conf.yaml.template:/ragflow/conf/service_conf.yaml.template
      - ./entrypoint.sh:/ragflow/entrypoint.sh
    env_file: .env
    networks:
      - ragflow
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ---------------------------------------------------------------------------
  # RAGFLOW GPU - Configuração original do RAGFlow (para quem tem GPU NVIDIA)
  # ---------------------------------------------------------------------------
  ragflow-gpu:
    depends_on:
      mysql:
        condition: service_healthy
    profiles:
      - gpu
    image: ${RAGFLOW_IMAGE}
    command:
      - --enable-adminserver
    ports:
      - ${SVR_WEB_HTTP_PORT}:80
      - ${SVR_WEB_HTTPS_PORT}:443
      - ${SVR_HTTP_PORT}:9380
      - ${ADMIN_SVR_HTTP_PORT}:9381
      - ${SVR_MCP_PORT}:9382
    volumes:
      - ./ragflow-logs:/ragflow/logs
      - ./nginx/ragflow.conf:/etc/nginx/conf.d/ragflow.conf
      - ./nginx/proxy.conf:/etc/nginx/proxy.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./service_conf.yaml.template:/ragflow/conf/service_conf.yaml.template
      - ./entrypoint.sh:/ragflow/entrypoint.sh
    env_file: .env
    networks:
      - ragflow
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ---------------------------------------------------------------------------
  # OLLAMA - LLM Local para os Agentes
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - ${OLLAMA_PORT:-11434}:11434
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ragflow
    restart: unless-stopped
    # Descomente as linhas abaixo se tiver GPU NVIDIA
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ---------------------------------------------------------------------------
  # INICIALIZADOR DE BANCO DE DADOS
  # Executa o script SQL para criar tabelas de análise de risco
  # ---------------------------------------------------------------------------
  db-init:
    image: mysql:8.0
    container_name: db-init
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-infini_rag_flow}
      MYSQL_DB: ${MYSQL_DBNAME:-rag_flow}
    volumes:
      - ./init_credit_db.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      sh -c "
      echo 'Aguardando MySQL ficar pronto...'
      sleep 10
      echo 'Executando script de inicialização...'
      mysql -h mysql -u root -p${MYSQL_PASSWORD:-infini_rag_flow} ${MYSQL_DBNAME:-rag_flow} < /docker-entrypoint-initdb.d/init.sql
      echo 'Script executado com sucesso!'
      "
    networks:
      - ragflow
    restart: "no"

  # ---------------------------------------------------------------------------
  # CREWAI APP - Aplicação Streamlit com Sistema de Agentes
  # ---------------------------------------------------------------------------
  crewai_app:
    build: ./crewai_app
    container_name: crewai_app
    ports:
      - "8501:8501"
    environment:
      # RAGFlow
      - RAGFLOW_API_URL=http://ragflow-cpu:9380/api/v1
      - RAGFLOW_API_KEY=${RAGFLOW_API_KEY:-}
      
      # Ollama
      - OLLAMA_BASE_URL=http://ollama:11434
      
      # MySQL - Banco de Dados
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-infini_rag_flow}
      - MYSQL_DATABASE=${MYSQL_DBNAME:-rag_flow}
      
      # Streamlit
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_LOGGER_LEVEL=info
    volumes:
      - ./crewai_app:/app
    command: streamlit run main.py --server.address=0.0.0.0
    depends_on:
      mysql:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    networks:
      - ragflow
    restart: unless-stopped

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin
    ports:
      - "8080:80"  # Acesse via http://localhost:8080 no navegador
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_PASSWORD:-infini_rag_flow}
      PMA_ARBITRARY: 1  # Permite conectar a qualquer servidor (opcional, para flexibilidade)
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ragflow
    restart: unless-stopped
# =============================================================================
# VOLUMES ADICIONAIS
# =============================================================================
volumes:
  ollama_data:
    driver: local
